#!/bin/sh -e

export CFLAGS="$(echo "$CFLAGS" | sed 's/ -fno-plt//')"
export LDFLAGS="${LDFLAGS%,-z,now}"

patch -p1 < rootless_modesetting.patch
patch -p1 < fix-crash.patch

./configure \
    --prefix=/usr \
    --localstatedir=/var \
    --disable-systemd-logind \
    --disable-xwayland \
    --disable-unit-tests \
    --enable-glx \
    --enable-dri \
    --enable-dri2 \
    --enable-dri3 \
    --enable-glamor \
    --enable-xorg \
    --with-sha1=libcrypto \
    --with-systemd-daemon=off

make
make install
